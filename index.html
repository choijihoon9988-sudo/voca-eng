<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voca-Core ENG (v1.0): ìˆ˜ëŠ¥ ì˜ì–´</title>
    <style>
        /* --- CSS ë³€ìˆ˜ ë° ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --background-color: #f4f4f9;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--dark-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 1rem;
        }

        /* --- ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆì´ì•„ì›ƒ --- */
       .app-container {
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        header {
            width: 100%;
            text-align: center;
            margin-bottom: 0;
        }

        header h1 {
            font-size: 1.75rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        /* --- í—¤ë” ì•„ë˜ ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ --- */
        .navigation-links {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .nav-link {
            font-size: 0.9rem;
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .nav-link:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }
        /* --- ì—¬ê¸°ê¹Œì§€ --- */


        /* --- í•™ìŠµ ì§„í–‰ë¥  UI --- */
       .progress-container {
            width: 100%;
        }

       .progress-text {
            font-size: 0.9rem;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
            text-align: center;
        }

       .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

       .progress-bar-inner {
            height: 100%;
            width: 0%;
            background-color: var(--success-color);
            transition: width 0.3s ease-in-out;
        }

        /* --- íƒ­ ê³µí†µ ìŠ¤íƒ€ì¼ --- */
       .tabs-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: var(--border-radius);
            padding: 5px;
        }

       .tabs-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
       }

       .tabs-grid button {
            flex: 1 1 auto;
            min-width: 80px;
            padding: 0.7rem 0.5rem;
            border: none;
            background-color: transparent;
            color: var(--secondary-color);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 9px;
            transition: all 0.3s ease;
       }
       .tabs-grid button:hover:not(.active) {
            background-color: #dfe3e7;
       }
       .tabs-grid button.active {
            background-color: var(--card-bg);
            color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
       }

       /* í˜„ì¬ í•™ìŠµ í˜„í™© í…ìŠ¤íŠ¸ */
       .context-text {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--secondary-color);
            text-align: center;
            margin-top: 0.5rem;
            min-height: 1.2em;
       }

        /* --- ë©”ì¸ ì½˜í…ì¸  (ì¹´ë“œ & í€´ì¦ˆ) --- */
        #main-content {
            width: 100%;
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }

       .card-container {
            width: 100%;
            height: 450px;
            perspective: 1000px;
            cursor: pointer;
        }

       .card__inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

       .card-container.is-flipped .card__inner {
            transform: rotateY(180deg);
        }

       .card__face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 2rem;
            overflow-y: auto;
        }

       .card__face--back {
            transform: rotateY(180deg);
        }

       .tts-speaker-btn {
            font-size: 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0 0.5rem;
            vertical-align: middle;
            color: var(--secondary-color);
            transition: color 0.2s ease;
        }
       .tts-speaker-btn:hover {
            color: var(--primary-color);
        }

       .card-front-header {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
       }

       .card-lemma {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            margin-right: 0.5rem;
        }

       .card-pos {
            font-size: 1rem;
            font-style: italic;
            color: var(--secondary-color);
            width: 100%;
            margin-bottom: 0.25rem;
        }

       .card-content-section {
            margin-bottom: 1.5rem;
        }
       .card-content-section:last-child {
            margin-bottom: 0;
        }

       .card-content-section h3 {
            font-size: 0.9rem;
            color: var(--secondary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

       .card-content-section h3 .tts-speaker-btn {
            font-size: 1.2rem;
        }

       .card-korean-meaning {
            font-size: 1.5rem;
            font-weight: 600;
        }

       .card-example {
            font-size: 1rem;
            line-height: 1.6;
        }

       .card-example-translation {
            font-size: 0.9rem;
            color: var(--secondary-color);
            margin-top: 0.5rem;
        }

       .card-inflected {
            font-size: 1rem;
            color: var(--primary-color);
            font-weight: 500;
            line-height: 1.5;
            word-break: break-all;
        }
       .card-inflected span {
            font-weight: bold;
            color: var(--dark-color);
        }

       .quiz-container {
            width: 100%;
            height: 450px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

       .quiz-question-sentence {
            font-size: 1.25rem;
            line-height: 1.7;
            text-align: center;
            color: var(--dark-color);
            margin-bottom: 1rem;
        }

       .quiz-question-sentence strong {
            color: var(--primary-color);
            font-family: monospace;
            font-size: 1.3rem;
        }

       .quiz-hint {
            font-size: 1.1rem;
            text-align: center;
            color: var(--secondary-color);
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

       .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

       .option-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            background-color: #fcfcfc;
            color: var(--dark-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
       .option-btn:hover:not(:disabled) {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
       .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.9;
        }
       .option-btn.correct {
            background-color: var(--success-color);
            border-color: var(--success-color);
            color: white;
            font-weight: bold;
        }
       .option-btn.incorrect {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }

       .quiz-feedback {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            border-top: 1px solid #eee;
            padding-top: 1.5rem;
        }

       .quiz-feedback p {
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
        }
       .quiz-feedback p.correct { color: var(--success-color); }
       .quiz-feedback p.incorrect { color: var(--danger-color); }

       .quiz-feedback button {
            width: 100%;
            padding: 0.8rem;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
        }

       .btn-review-mistake {
            background-color: transparent;
            border: 2px solid var(--warning-color);
            color: var(--warning-color);
        }
       .btn-review-mistake:hover {
            background-color: var(--warning-color);
            color: var(--dark-color);
       }

       .btn-next-quiz {
            background-color: var(--primary-color);
            border: 2px solid var(--primary-color);
            color: white;
       }
       .btn-next-quiz:hover {
            opacity: 0.8;
       }

       .knowledge-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            width: 100%;
        }

       .knowledge-controls button {
            padding: 1rem;
            font-size: 1rem;
            font-weight: bold;
            border: 2px solid;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
        }

       .btn-unknown {
            background-color: transparent;
            border-color: var(--danger-color);
            color: var(--danger-color);
        }
       .btn-unknown:hover {
            background-color: var(--danger-color);
            color: white;
        }

       .btn-known {
            background-color: transparent;
            border-color: var(--success-color);
            color: var(--success-color);
        }
       .btn-known:hover {
            background-color: var(--success-color);
            color: white;
        }

        /* (v3.5) Footer ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
       .navigation-controls {
            display: flex;
            justify-content: center; /* ë²„íŠ¼ í•˜ë‚˜ ì¤‘ì•™ ì •ë ¬ */
            width: 100%;
            min-height: 48px; /* ë²„íŠ¼ì´ ì—†ì„ ë•Œë„ ê³µê°„ ìœ ì§€ */
        }
        /* (v3.5) ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ê´€ë ¨ ìŠ¤íƒ€ì¼ ì œê±° */
       /* .navigation-controls button { ... } */
       /* .navigation-controls button#btn-prev, .navigation-controls button#btn-next { ... } */
       /* .navigation-controls button:hover { ... } */
       /* .navigation-controls button:disabled { ... } */

        /* (v3.5) 'í€´ì¦ˆë¡œ ëŒì•„ê°€ê¸°' ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìœ ì§€ ë° ì¤‘ì•™ ì •ë ¬ */
       .navigation-controls button#btn-back-to-quiz {
            background-color: var(--secondary-color);
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
            width: 100%; /* ë²„íŠ¼ì´ í•˜ë‚˜ì¼ ë•Œ ì „ì²´ ë„ˆë¹„ ì°¨ì§€ */
            max-width: 300px; /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
       }
        .navigation-controls button#btn-back-to-quiz:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
       }


       .message-container {
            text-align: center;
            font-size: 1.2rem;
            color: var(--secondary-color);
            height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 2rem;
        }

       .hidden {
            display: none !important;
        }

        /* --- (ì‹ ê·œ) í‘¸í„° ìŠ¤íƒ€ì¼ --- */
       .app-footer {
            width: 100%;
            max-width: 420px; /* app-containerì™€ ë™ì¼í•˜ê²Œ */
            text-align: center;
            padding: 1rem;
            font-size: 0.85rem;
            color: var(--secondary-color);
            margin-top: 1rem;
            line-height: 1.6;
        }
       .app-footer p {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h1>Voca-Core ENG (v1.0)</h1>
        </header>
        <div class="navigation-links">
            <a href="wordlist.html" class="nav-link">&larr; ì „ì²´ ë‹¨ì–´ ëª©ë¡</a>
            <a href="pdf_library.html" class="nav-link">PDF ìë£Œì‹¤ &rarr;</a>
        </div>
        
        <section class="progress-container">
            <p class="progress-text" id="progress-text">ë‹¨ì–´ ë¡œë”© ì¤‘...</p>
            <div class="progress-bar">
                <div class="progress-bar-inner" id="progress-bar-inner"></div>
            </div>
        </section>
        
        <nav class="tabs-container mode-tabs">
            <div class="tabs-grid">
                <button class="mode-btn active" data-mode="card">í”Œë˜ì‹œì¹´ë“œ</button>
                <button class="mode-btn" data-mode="review">'ëª°ë¼ìš”' ë³µìŠµ</button>
                <button class="mode-btn" data-mode="grammar-quiz">ë¬¸ë²• í€´ì¦ˆ</button>
                <button class="mode-btn" data-mode="cloze-quiz">ì˜ˆë¬¸ í€´ì¦ˆ</button>
            </div>
            <p class="context-text" id="context-text">í•™ìŠµ í˜„í™© ë¡œë”© ì¤‘...</p>
        </nav>

        <main id="main-content">
            <div class="message-container">
                <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
        </main>

        <section class="knowledge-controls" id="knowledge-controls">
            <button class="btn-unknown" id="btn-unknown">âŒ ëª°ë¼ìš”</button>
            <button class="btn-known" id="btn-known">âœ… ì•Œì•„ìš”</button>
        </section>

        <footer class="navigation-controls" id="navigation-controls">
            <button id="btn-back-to-quiz" class="hidden">â—€ í€´ì¦ˆë¡œ ëŒì•„ê°€ê¸°</button>
            </footer>
    </div>

    <footer class="app-footer">
        <p>Â© ì§€í›„ë¥¼ ê°€ì¥ ì‘ì›í•˜ëŠ” ìµœì¬ì˜</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ ---
            let allWordsData = [];
            let allWords = [];
            let filteredWords = [];
            let currentIndex = 0;
            let progress = {};
            let currentMode = 'card';

            const LOCAL_STORAGE_KEY = 'vocaCoreEngProgress'; // (ìˆ˜ì •)

            let lastQuizMode = 'grammar-quiz';
            let quizReturnIndex = 0;
            let currentUtterance = null;

            // --- UI í…ìŠ¤íŠ¸ ë§¤í•‘ ---
            const MODE_NAMES = {
                'card': 'í”Œë˜ì‹œì¹´ë“œ',
                'review': "'ëª°ë¼ìš”' ë³µìŠµ",
                'grammar-quiz': 'ë¬¸ë²• í€´ì¦ˆ',
                'cloze-quiz': 'ì˜ˆë¬¸ í€´ì¦ˆ'
            };

            // --- DOM ìš”ì†Œ ì°¸ì¡° ---
            const mainContent = document.getElementById('main-content');
            const progressText = document.getElementById('progress-text');
            const progressBarInner = document.getElementById('progress-bar-inner');
            const contextText = document.getElementById('context-text');
            const knowledgeControls = document.getElementById('knowledge-controls');
            const navigationControls = document.getElementById('navigation-controls');
            // (v3.5) btnPrev, btnNext ì œê±°
            const btnKnown = document.getElementById('btn-known');
            const btnUnknown = document.getElementById('btn-unknown');
            const modeButtons = document.querySelectorAll('.mode-btn');
            const btnBackToQuiz = document.getElementById('btn-back-to-quiz');


            // --- TTS ìŒì„± ì¶œë ¥ í•¨ìˆ˜ (v3.4 ìˆ˜ì •ë¨) ---
            function speakText(text, lang = 'en-US') { // (ìˆ˜ì •)
                if (!('speechSynthesis' in window)) {
                    alert('ì£„ì†¡í•©ë‹ˆë‹¤. ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }
                window.speechSynthesis.cancel();
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.lang = lang;
                currentUtterance.rate = 0.9;
                currentUtterance.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror', event);
                    currentUtterance = null;
                };
                currentUtterance.onend = () => {
                    currentUtterance = null;
                };
                window.speechSynthesis.speak(currentUtterance);
            }

            // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
            const shuffleArray = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

             // --- ë°ì´í„° ë¡œë”© ë° ì´ˆê¸°í™” ---
             async function initializeApp() {
                 try {
                     const response = await fetch('voca-core-eng.json'); // (ìˆ˜ì •)
                     if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                     allWordsData = await response.json();
                     allWords = allWordsData;

                     if (allWords.length === 0) {
                          console.warn(`ë‹¨ì–´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                     }

                     loadProgress();

                     // --- wordlist.htmlì—ì„œ ì í”„í–ˆëŠ”ì§€ í™•ì¸ ---
                     const jumpToRank = localStorage.getItem('vocaCoreEngJumpToRank'); // (ìˆ˜ì •)
                     let startMode = 'card';

                     if (jumpToRank) {
                         const rank = parseInt(jumpToRank, 10);
                         const jumpWord = allWordsData.find(w => w.rank === rank);

                         if (jumpWord) {
                             const jumpIndex = allWords.findIndex(w => w.rank === rank);
                             if (jumpIndex !== -1) {
                                 currentIndex = jumpIndex;
                                 startMode = 'card';
                             }
                         }
                         localStorage.removeItem('vocaCoreEngJumpToRank'); // (ìˆ˜ì •)
                     }
                     // --- ì—¬ê¸°ê¹Œì§€ ---

                     setMode(startMode, true);

                 } catch (error) {
                     console.error("ë‹¨ì–´ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
                     mainContent.innerHTML = `<div class="message-container"><p>ë‹¨ì–´ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>'voca-core-eng.json' íŒŒì¼ì´ ê°™ì€ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p></div>`; // (ìˆ˜ì •)
                     progressText.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
                 }
             }


            // --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ ---
            function loadProgress() {
                try {
                    const savedProgress = localStorage.getItem(LOCAL_STORAGE_KEY);
                    progress = savedProgress ? JSON.parse(savedProgress) : {};
                } catch (e) { console.error("ì§„í–‰ë¥  íŒŒì‹± ì‹¤íŒ¨:", e); progress = {}; }
            }

            function saveProgress() {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(progress));
                } catch (e) { console.error("ì§„í–‰ë¥  ì €ì¥ ì‹¤íŒ¨:", e); }
            }

            // --- í•µì‹¬ í•„í„° ë¡œì§ ---
            function updateFilters() {
                let tempWords = [...allWords];

                if (currentMode === 'review') {
                    tempWords = tempWords.filter(w => progress[w.lemma] !== true);
                }

                if (currentMode === 'grammar-quiz' || currentMode === 'cloze-quiz') {
                    tempWords = shuffleArray(tempWords);
                    knowledgeControls.classList.add('hidden');
                    navigationControls.classList.add('hidden'); // (v3.5) í€´ì¦ˆ ëª¨ë“œì—ì„œëŠ” ë„¤ë¹„ê²Œì´ì…˜ ìˆ¨ê¹€
                } else {
                    knowledgeControls.classList.remove('hidden');
                    updateNavigation(); // (v3.5) ì¹´ë“œ ëª¨ë“œì—ì„œ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                }

                filteredWords = tempWords;

                updateContextText();
                if (currentMode === 'card' || currentMode === 'review') {
                    renderCard();
                } else {
                    renderQuiz();
                }
                updateGlobalProgressUI();
            }

            // --- ëª¨ë“œ ì„¤ì • ---
            function setMode(mode, isInitializationJump = false) {
                currentMode = mode;

                if (!isInitializationJump) {
                    currentIndex = 0;
                }

                // (v3.5) ë²„íŠ¼ í‘œì‹œ ë¡œì§ ë‹¨ìˆœí™”
                btnBackToQuiz.classList.add('hidden');

                modeButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });

                if (mode === 'grammar-quiz' || mode === 'cloze-quiz') {
                    lastQuizMode = mode;
                }
                updateFilters();
            }

            // --- UI ë Œë”ë§: í”Œë˜ì‹œì¹´ë“œ ---
            function renderCard(forceFlip = false) {
                 if (filteredWords.length === 0 || currentIndex >= filteredWords.length) {
                     // ì¸ë±ìŠ¤ ì¡°ì • ë¡œì§ ìœ ì§€
                     if (filteredWords.length > 0 && currentIndex >= filteredWords.length) {
                         currentIndex = filteredWords.length -1; // (v3.5) ë§ˆì§€ë§‰ ë‹¨ì–´ë¡œ ì¡°ì •
                     } else if (filteredWords.length === 0) {
                         currentIndex = 0;
                     }

                     const message = (currentMode === 'review')
                         ? 'ë³µìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‰'
                         : (allWords.length > 0 ? 'ëª¨ë“  ë‹¨ì–´ë¥¼ í•™ìŠµí–ˆìŠµë‹ˆë‹¤. ğŸ‘' : 'ë¡œë”© ì¤‘...'); // (v3.5) ì™„ë£Œ ë©”ì‹œì§€ ìˆ˜ì •
                     mainContent.innerHTML = `<div class="message-container"><p>${message}</p></div>`;
                     knowledgeControls.classList.add('hidden');
                     navigationControls.classList.add('hidden'); // (v3.5) ì™„ë£Œ ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìˆ¨ê¹€
                     return;
                 }

                 knowledgeControls.classList.remove('hidden');

                const word = filteredWords[currentIndex];
                 if (!word) {
                     console.error("RenderCard: word is undefined at index", currentIndex);
                     mainContent.innerHTML = `<div class="message-container"><p>ì˜¤ë¥˜: ë‹¨ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
                     return;
                 }
                 const inflectedFormsHTML = word.inflected_forms_found ? word.inflected_forms_found.join(', ') : 'N/A';
                 const categoryDisplayName = word.category || 'N/A';

                // ì¹´ë“œ HTML ìƒì„± ë¡œì§ ìœ ì§€ (tts ë²„íŠ¼ í¬í•¨)
                const cardHTML = `
                    <div class="card-container ${forceFlip ? 'is-flipped' : ''}" id="card-container">
                        <div class="card__inner">
                            <div class="card__face card__face--front">
                                <div class="card-front-header">
                                    <p class="card-pos">${word.part_of_speech} / ${categoryDisplayName}</p>
                                    <h2 class="card-lemma">${word.lemma}</h2>
                                    <button class="tts-speaker-btn" id="tts-lemma-btn" title="ë‹¨ì–´ ë°œìŒ ë“£ê¸°">ğŸ”Š</button>
                                </div>
                                <div style="text-align:center; color: var(--secondary-color);">ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ ëœ» í™•ì¸</div>
                            </div>
                            <div class="card__face card__face--back">
                                <div class="card-content-section">
                                    <h3>ëœ»</h3>
                                    <p class="card-korean-meaning">${word.korean_meaning}</p>
                                </div>
                                <div class="card-content-section">
                                    <h3>ì‹¤ì œ ê¸°ì¶œ í˜•íƒœ</h3>
                                    <p class="card-inflected"><span>[ì‹¤ì œ ê¸°ì¶œ í˜•íƒœ]</span> ${inflectedFormsHTML}</p>
                                </div>
                                <div class="card-content-section">
                                    <h3> <span>ì˜ˆë¬¸</span>
                                        <button class="tts-speaker-btn" id="tts-example-btn" title="ì˜ˆë¬¸ ë°œìŒ ë“£ê¸°">ğŸ”Š</button>
                                    </h3>
                                    <p class="card-example">"${word.example_sentence_source || 'ì˜ˆë¬¸ ì—†ìŒ'}"</p>
                                    <p class="card-example-translation">${word.example_sentence_translation || 'ë²ˆì—­ ì—†ìŒ'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                mainContent.innerHTML = cardHTML;

                // TTS ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë¡œì§ ìœ ì§€)
                const ttsLemmaBtn = document.getElementById('tts-lemma-btn');
                const ttsExampleBtn = document.getElementById('tts-example-btn');
                if (ttsLemmaBtn) {
                    ttsLemmaBtn.addEventListener('click', (e) => { e.stopPropagation(); speakText(word.lemma, 'en-US'); }); // (ìˆ˜ì •)
                }
                if (ttsExampleBtn && word.example_sentence_source) {
                    ttsExampleBtn.addEventListener('click', (e) => { e.stopPropagation(); speakText(word.example_sentence_source, 'en-US'); }); // (ìˆ˜ì •)
                } else if (ttsExampleBtn) {
                    ttsExampleBtn.disabled = true;
                    ttsExampleBtn.style.opacity = 0.5;
                 }


                // ì¹´ë“œ ë’¤ì§‘ê¸° ë¦¬ìŠ¤ë„ˆ (ë¡œì§ ìœ ì§€)
                document.getElementById('card-container').addEventListener('click', () => {
                    document.getElementById('card-container').classList.toggle('is-flipped');
                });

                updateNavigation(); // (v3.5) ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
            }

            // --- UI ë Œë”ë§: í€´ì¦ˆ ---
            function renderQuiz() {
                 navigationControls.classList.add('hidden'); // í€´ì¦ˆ ëª¨ë“œì—ì„œëŠ” í•­ìƒ ìˆ¨ê¹€

                 if (filteredWords.length === 0 || currentIndex >= filteredWords.length) {
                     // ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ ë¡œì§ ìœ ì§€
                     if (currentIndex >= filteredWords.length && filteredWords.length > 0) {
                         currentIndex = filteredWords.length -1; // ë§ˆì§€ë§‰ ë¬¸ì œë¡œ ì¡°ì •
                     }

                     if (filteredWords.length === 0 || currentIndex >= filteredWords.length) {
                          mainContent.innerHTML = `<div class="message-container"><p>ëª¨ë“  í€´ì¦ˆë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ğŸ¥³</p></div>`;
                          return;
                     }
                 }

                const word = filteredWords[currentIndex];
                let quizHTML = '';

                if (currentMode === 'grammar-quiz') {
                    quizHTML = generateGrammarQuiz(word, allWords);
                } else { // cloze-quiz
                    quizHTML = generateClozeQuiz(word, allWords);
                }

                mainContent.innerHTML = quizHTML;

                // í€´ì¦ˆ ì˜µì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë¡œì§ ìœ ì§€)
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        handleQuizAnswer(e.target.dataset.option, e.target.dataset.answer, e.target);
                    });
                });

                 // (v3.5) í€´ì¦ˆ ë Œë”ë§ í›„ ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ ì¶”ê°€
                 const btnNextQuiz = document.getElementById('btn-next-quiz');
                 if(btnNextQuiz) {
                     btnNextQuiz.onclick = () => handleNavigation(1); // ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
                 }
                 const btnReviewMistake = document.getElementById('btn-review-mistake');
                 if(btnReviewMistake) {
                     const currentWord = filteredWords[currentIndex];
                     if (currentWord) { // currentWordê°€ ìœ íš¨í•œì§€ í™•ì¸
                        btnReviewMistake.onclick = () => jumpToReview(currentWord.lemma);
                     } else {
                        console.error("RenderQuiz: Cannot set onclick for btnReviewMistake, currentWord is invalid.");
                     }
                 }
            }


            // --- ë¬¸ë²• í€´ì¦ˆ ìƒì„±ê¸° (ë¡œì§ ìœ ì§€) ---
            function generateGrammarQuiz(word, wordPool) {
                 if (!word.example_sentence_source || !word.inflected_forms_found || word.inflected_forms_found.length === 0) {
                     return `<div class="message-container"><p>ì´ ë‹¨ì–´ì— ëŒ€í•œ ë¬¸ë²• í€´ì¦ˆë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><button onclick="window.handleNavigation(1)" class="btn-next-quiz" style="margin-top: 1rem;">ë‹¤ìŒ ë¬¸ì œë¡œ â–¶</button></div>`; // (v3.5) onclick ìˆ˜ì •
                 }
                 // ë‚˜ë¨¸ì§€ ë¡œì§ì€ ë™ì¼
                const sortedForms = [...word.inflected_forms_found].sort((a, b) => b.length - a.length);
                 let correctForm = sortedForms.find(form => word.example_sentence_source.toLowerCase().includes(form.toLowerCase()));
                if (!correctForm) correctForm = word.inflected_forms_found[0];

                 const sentence = word.example_sentence_source;
                 let questionSentence = sentence;
                 try {
                    const regex = new RegExp(`\\b${correctForm}\\b`, 'gi');
                     if (regex.test(sentence)) {
                        questionSentence = sentence.replace(regex, "<strong>_____</strong>");
                    } else {
                         const index = sentence.toLowerCase().indexOf(correctForm.toLowerCase());
                         if(index !== -1) {
                             questionSentence = sentence.substring(0, index) + "<strong>_____</strong>" + sentence.substring(index + correctForm.length);
                         } else {
                             console.warn(`Cannot find correctForm '${correctForm}' in sentence: ${sentence}`);
                              questionSentence = sentence + " (Choose form for: " + word.lemma + ")";
                         }
                    }
                 } catch(e) {
                      console.error("Error creating question sentence:", e);
                      questionSentence = sentence.replace(correctForm, "<strong>_____</strong>");
                 }


                let options = [...new Set(word.inflected_forms_found)];
                let attempts = 0;
                while (options.length < 4 && wordPool.length > options.length && attempts < 50) {
                    const randomWordIndex = Math.floor(Math.random() * wordPool.length);
                    const randomWord = wordPool[randomWordIndex];
                     if (randomWord.lemma !== word.lemma && randomWord.inflected_forms_found && randomWord.inflected_forms_found.length > 0) {
                        const randomForm = randomWord.inflected_forms_found[Math.floor(Math.random() * randomWord.inflected_forms_found.length)];
                        if (!options.includes(randomForm)) {
                            options.push(randomForm);
                        }
                    }
                    attempts++;
                }

                 if (options.length > 4) {
                     let wrongOptions = options.filter(opt => opt !== correctForm);
                     wrongOptions = shuffleArray(wrongOptions);
                     options = [correctForm, ...wrongOptions.slice(0, 3)];
                 } else if (!options.includes(correctForm)) {
                      if(options.length > 0) options.pop();
                      options.push(correctForm);
                 }


                options = shuffleArray(options);

                const optionsHTML = options.map(opt =>
                    `<button class="option-btn" data-option="${opt}" data-answer="${correctForm}">${opt}</button>`
                ).join('');

                return `
                    <div class="quiz-container">
                        <div>
                            <p class="quiz-question-sentence">${questionSentence}</p>
                            <p class="quiz-hint">ë¬¸ë§¥ì— ë§ëŠ” 'ì‹¤ì „ í˜•íƒœ'ë¥¼ ê³ ë¥´ì„¸ìš”.</p>
                        </div>
                        <div class="quiz-options">
                            ${optionsHTML}
                        </div>
                        <div id="quiz-feedback" class="quiz-feedback hidden">
                            <p id="feedback-message"></p>
                            <button id="btn-review-mistake" class="btn-review-mistake"></button>
                            <button id="btn-next-quiz" class="btn-next-quiz">ë‹¤ìŒ ë¬¸ì œë¡œ â–¶</button>
                        </div>
                    </div>`;
            }

            // --- ì˜ˆë¬¸ í€´ì¦ˆ ìƒì„±ê¸° (ë¡œì§ ìœ ì§€) ---
            function generateClozeQuiz(word, wordPool) {
                 if (!word.example_sentence_source) {
                      return `<div class="message-container"><p>ì´ ë‹¨ì–´ì— ëŒ€í•œ ì˜ˆë¬¸ í€´ì¦ˆë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><button onclick="window.handleNavigation(1)" class="btn-next-quiz" style="margin-top: 1rem;">ë‹¤ìŒ ë¬¸ì œë¡œ â–¶</button></div>`; // (v3.5) onclick ìˆ˜ì •
                 }
                // ë‚˜ë¨¸ì§€ ë¡œì§ì€ ë™ì¼
                 let questionSentence = word.example_sentence_source;
                 let correctLemma = word.lemma;
                  try {
                       const regex = new RegExp(`\\b${word.lemma}\\b`, 'gi');
                       if (regex.test(questionSentence)) {
                           questionSentence = questionSentence.replace(regex, "<strong>_____</strong>");
                       } else {
                            const index = questionSentence.toLowerCase().indexOf(word.lemma.toLowerCase());
                            if(index !== -1) {
                                questionSentence = questionSentence.substring(0, index) + "<strong>_____</strong>" + questionSentence.substring(index + word.lemma.length);
                            } else {
                                 const formsInSentence = word.inflected_forms_found?.filter(f => questionSentence.toLowerCase().includes(f.toLowerCase())) || [];
                                 if (formsInSentence.length > 0) {
                                      const formToReplace = formsInSentence.sort((a,b)=> b.length - a.length)[0];
                                      const formRegex = new RegExp(`\\b${formToReplace}\\b`, 'gi');
                                       if(formRegex.test(questionSentence)) {
                                           questionSentence = questionSentence.replace(formRegex, "<strong>_____</strong>");
                                       } else {
                                            const formIndex = questionSentence.toLowerCase().indexOf(formToReplace.toLowerCase());
                                             if(formIndex !== -1) {
                                                 questionSentence = questionSentence.substring(0, formIndex) + "<strong>_____</strong>" + questionSentence.substring(formIndex + formToReplace.length);
                                             }
                                       }
                                 } else {
                                     console.warn(`Cannot find lemma '${word.lemma}' or its forms in sentence: ${questionSentence}`);
                                      questionSentence = questionSentence + " (Choose lemma: " + word.lemma + ")";
                                 }
                            }
                       }
                  } catch(e) {
                      console.error("Error creating cloze question:", e);
                       const regexFallback = new RegExp(`\\b${word.lemma}\\b`, 'gi');
                       questionSentence = word.example_sentence_source.replace(regexFallback, "<strong>_____</strong>");
                  }

                const hint = `íŒíŠ¸: ${word.korean_meaning}`;

                let options = [correctLemma];
                let attempts = 0;
                while (options.length < 4 && wordPool.length > options.length && attempts < 50) {
                    const randomWord = wordPool[Math.floor(Math.random() * wordPool.length)];
                    if (randomWord.lemma !== correctLemma && !options.includes(randomWord.lemma)) {
                        options.push(randomWord.lemma);
                    }
                    attempts++;
                }
                options = shuffleArray(options);

                const optionsHTML = options.map(opt =>
                    `<button class="option-btn" data-option="${opt}" data-answer="${correctLemma}">${opt}</button>`
                ).join('');

                return `
                    <div class="quiz-container">
                        <div>
                            <p class="quiz-question-sentence">${questionSentence}</p>
                            <p class="quiz-hint">${hint}</p>
                        </div>
                        <div class="quiz-options">
                            ${optionsHTML}
                        </div>
                        <div id="quiz-feedback" class="quiz-feedback hidden">
                            <p id="feedback-message"></p>
                            <button id="btn-review-mistake" class="btn-review-mistake"></button>
                            <button id="btn-next-quiz" class="btn-next-quiz">ë‹¤ìŒ ë¬¸ì œë¡œ â–¶</button>
                        </div>
                    </div>`;
            }


            // --- í€´ì¦ˆ ì •ë‹µ ì²˜ë¦¬ ---
            function handleQuizAnswer(selectedOption, correctOption, buttonElement) {
                document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);

                const feedbackContainer = document.getElementById('quiz-feedback');
                const feedbackMessage = document.getElementById('feedback-message');
                const btnReviewMistake = document.getElementById('btn-review-mistake');
                const btnNextQuiz = document.getElementById('btn-next-quiz');

                feedbackContainer.classList.remove('hidden');
                // navigationControlsëŠ” í€´ì¦ˆ ëª¨ë“œì—ì„œ í•­ìƒ ìˆ¨ê²¨ì ¸ ìˆìŒ

                const currentWord = filteredWords[currentIndex];
                let isCorrect = (selectedOption === correctOption);

                if (isCorrect) {
                    buttonElement.classList.add('correct');
                    feedbackMessage.textContent = "ì •ë‹µì…ë‹ˆë‹¤! ğŸ¥³";
                    feedbackMessage.className = 'correct';
                    btnReviewMistake.classList.add('hidden');
                    progress[currentWord.lemma] = true;
                    // (v3.5) ë‹¤ìŒ ë²„íŠ¼ onclickì€ renderQuizì—ì„œ ì„¤ì •
                } else {
                    buttonElement.classList.add('incorrect');
                     const correctButton = document.querySelector(`.option-btn[data-option="${correctOption}"]`);
                     if (correctButton) correctButton.classList.add('correct');

                    feedbackMessage.textContent = "ì•„ì‰½ë„¤ìš”. ë‹¤ì‹œ í™•ì¸í•´ë³¼ê¹Œìš”?";
                    feedbackMessage.className = 'incorrect';

                     let wordToReviewLemma = currentWord.lemma; // ì—¬ê¸°ì„œ lemmaë¥¼ ê°€ì ¸ì˜´

                    btnReviewMistake.textContent = `â” '${wordToReviewLemma}' ë³µìŠµí•˜ê¸°`;
                    btnReviewMistake.classList.remove('hidden');
                    // (v3.5) ë³µìŠµ ë²„íŠ¼ onclickì€ renderQuizì—ì„œ ì„¤ì •

                    progress[currentWord.lemma] = false;
                     // (v3.5) ë‹¤ìŒ ë²„íŠ¼ onclickì€ renderQuizì—ì„œ ì„¤ì •
                }

                saveProgress();
                updateGlobalProgressUI();
            }

            // --- 'ì¦‰ì‹œ ë³µìŠµ' ì í”„ ê¸°ëŠ¥ ---
             function jumpToReview(lemmaToReview) {
                 quizReturnIndex = currentIndex;

                 const reviewWord = allWordsData.find(w => w.lemma === lemmaToReview);
                 if (!reviewWord) {
                     console.error(`Cannot find word with lemma: ${lemmaToReview}`);
                     return;
                 }

                 const reviewIndex = allWords.findIndex(w => w.lemma === lemmaToReview);
                 if (reviewIndex === -1) return;


                 // 'í”Œë˜ì‹œì¹´ë“œ' ëª¨ë“œë¡œ ê°•ì œ ì „í™˜
                 currentMode = 'card';
                 modeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.mode === 'card'));

                 updateFilters(); // í•„í„° ì—…ë°ì´íŠ¸ (filteredWords ê°±ì‹ )

                 currentIndex = reviewIndex; // í•´ë‹¹ ë‹¨ì–´ ì¸ë±ìŠ¤ë¡œ ì„¤ì •

                 knowledgeControls.classList.add('hidden'); // ë³µìŠµ ì‹œ ì•Œì•„ìš”/ëª°ë¼ìš” ìˆ¨ê¹€

                 navigationControls.classList.remove('hidden'); // ë„¤ë¹„ê²Œì´ì…˜ ë³´ì´ê²Œ
                 btnBackToQuiz.classList.remove('hidden'); // í€´ì¦ˆ ë³µê·€ ë²„íŠ¼ í‘œì‹œ
                 // (v3.5) ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ì œê±°ë¨

                 renderCard(true); // ì¹´ë“œ ë’·ë©´ ê°•ì œ í‘œì‹œ
             }


             // --- UI ì—…ë°ì´íŠ¸ ---
             // ì „ì—­ ì§„í–‰ë¥  UI ì—…ë°ì´íŠ¸ (ë¡œì§ ìœ ì§€)
             function updateGlobalProgressUI() {
                 const totalCount = allWords.length;
                 if (totalCount === 0) return;

                 const knownCount = allWords.filter(w => progress[w.lemma] === true).length;

                 const percentage = (knownCount / totalCount) * 100;
                 progressText.textContent = `ì „ì²´ ë‹¨ì–´: ${knownCount} / ${totalCount}ê°œ (${percentage.toFixed(0)}%)`;
                 progressBarInner.style.width = `${percentage}%`;
             }

            // ì»¨í…ìŠ¤íŠ¸ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ë¡œì§ ìœ ì§€)
             function updateContextText() {
                 const modeName = MODE_NAMES[currentMode] || currentMode;
                 let text = `ì „ì²´ ë‹¨ì–´ | ${modeName}`;
                 text += ` (${filteredWords.length}ê°œ í•™ìŠµ)`;
                 contextText.textContent = text;
             }


             // (v3.5) ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ìˆ˜ì •
             function updateNavigation() {
                 // í€´ì¦ˆ ë³µê·€ ë²„íŠ¼ì´ ë³´ì´ë©´ í•­ìƒ ê·¸ê²ƒë§Œ í‘œì‹œ
                 if (!btnBackToQuiz.classList.contains('hidden')) {
                     navigationControls.classList.remove('hidden');
                 }
                 // í”Œë˜ì‹œì¹´ë“œ/ë¦¬ë·° ëª¨ë“œì´ê³ , ë³µê·€ ë²„íŠ¼ì´ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ ë„¤ë¹„ê²Œì´ì…˜ ì˜ì—­ ìˆ¨ê¹€
                 else if (currentMode === 'card' || currentMode === 'review') {
                     navigationControls.classList.add('hidden');
                 }
                 // í€´ì¦ˆ ëª¨ë“œì—ì„œëŠ” ì´ë¯¸ ìˆ¨ê²¨ì ¸ ìˆìŒ (renderQuizì—ì„œ ì²˜ë¦¬)
             }

            // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬: ë„¤ë¹„ê²Œì´ì…˜ (v3.5 ìˆ˜ì •) ---
            // handleNavigationì€ ì´ì œ ë‹¤ìŒ ì¹´ë“œ/í€´ì¦ˆë¡œ ë„˜ì–´ê°€ëŠ” ì—­í• ë§Œ í•¨
            function handleNavigation(direction) {
                 // í€´ì¦ˆ í”¼ë“œë°± ìˆ¨ê¹€ ë¡œì§ ìœ ì§€
                 const feedbackContainer = document.getElementById('quiz-feedback');
                 if (feedbackContainer && !feedbackContainer.classList.contains('hidden') && (currentMode === 'grammar-quiz' || currentMode === 'cloze-quiz')) {
                      feedbackContainer.classList.add('hidden');
                 }

                 const newIndex = currentIndex + direction;

                 // ì¸ë±ìŠ¤ ë²”ìœ„ í™•ì¸ ë° ì—…ë°ì´íŠ¸ ë¡œì§ ìœ ì§€
                 if (newIndex >= 0 && newIndex < filteredWords.length) {
                     currentIndex = newIndex;
                 } else if (newIndex >= filteredWords.length) {
                     // ë§ˆì§€ë§‰ ë‹¨ì–´/í€´ì¦ˆ ì´í›„ ì²˜ë¦¬ (ë Œë”ë§ í•¨ìˆ˜ì—ì„œ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ)
                     currentIndex = filteredWords.length; // ì¸ë±ìŠ¤ë¥¼ ë°°ì—´ ê¸¸ì´ë¡œ ì„¤ì •í•˜ì—¬ ì™„ë£Œ ìƒíƒœ í‘œì‹œ
                 } else {
                     // ì²« ë‹¨ì–´ ì´ì „ìœ¼ë¡œ ê°€ë ¤ê³  í•  ë•Œ (ì´ì „ ë²„íŠ¼ ì—†ìœ¼ë¯€ë¡œ ì‹¤ì œ ë°œìƒ ì•ˆ í•¨)
                     return;
                 }

                // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
                if (currentMode === 'card' || currentMode === 'review') {
                    renderCard();
                } else {
                    renderQuiz();
                }
            }
             // (v3.5) handleNavigationì„ ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œ (í€´ì¦ˆ HTML onclickì—ì„œ ì‚¬ìš©)
             window.handleNavigation = handleNavigation;


            // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬: í”Œë˜ì‹œì¹´ë“œ ìƒíƒœ ì €ì¥ (v3.5 ìˆ˜ì •) ---
            function markWord(isKnown) {
                if (filteredWords.length === 0 || currentIndex >= filteredWords.length) return;

                const currentWord = filteredWords[currentIndex];
                progress[currentWord.lemma] = isKnown;
                saveProgress();
                updateGlobalProgressUI();

                // 'ëª°ë¼ìš”' ë³µìŠµ ëª¨ë“œì—ì„œ 'ì•Œì•„ìš”'ë¥¼ ëˆ„ë¥´ë©´ ëª©ë¡ì—ì„œ ì œê±°
                if (currentMode === 'review' && isKnown) {
                     // filteredWordsì—ì„œ í˜„ì¬ ë‹¨ì–´ ì œê±°
                     filteredWords.splice(currentIndex, 1);

                     // ì¸ë±ìŠ¤ ì¡°ì •: ì œê±° í›„ í˜„ì¬ ì¸ë±ìŠ¤ê°€ ë°°ì—´ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ë§ˆì§€ë§‰ ìš”ì†Œë¡œ
                      if (currentIndex >= filteredWords.length) {
                          currentIndex = Math.max(0, filteredWords.length - 1);
                      }
                      // ì œê±° í›„ì—ë„ í˜„ì¬ ì¸ë±ìŠ¤ê°€ ìœ íš¨í•˜ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€ (ë‹¤ìŒ ë Œë”ë§ ì‹œ í˜„ì¬ ì¸ë±ìŠ¤ ë‹¨ì–´ í‘œì‹œ)

                     // ì ì‹œ í›„ ë‹¤ìŒ ì¹´ë“œ ë Œë”ë§ (ì¦‰ì‹œ ë Œë”ë§í•˜ë©´ ì œê±° íš¨ê³¼ê°€ ì˜ ì•ˆ ë³´ì¼ ìˆ˜ ìˆìŒ)
                     setTimeout(() => {
                          renderCard(); // í˜„ì¬ ì¸ë±ìŠ¤ë¡œ ë‹¤ì‹œ ë Œë”ë§
                          updateContextText();
                     }, 150);
                 } else {
                     // ê·¸ ì™¸ì˜ ê²½ìš° (ì¼ë°˜ ì¹´ë“œ ëª¨ë“œ ë˜ëŠ” 'ëª°ë¼ìš”'ì—ì„œ 'ëª°ë¼ìš”' í´ë¦­) ë‹¤ìŒ ì¹´ë“œë¡œ ì´ë™
                     setTimeout(() => { handleNavigation(1); }, 150); // ë‹¤ìŒ ì¹´ë“œë¡œ ë„˜ì–´ê°
                 }
            }

            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
            // (v3.5) btnPrev, btnNext ë¦¬ìŠ¤ë„ˆ ì œê±°
            btnKnown.addEventListener('click', () => markWord(true));
            btnUnknown.addEventListener('click', () => markWord(false));

            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // currentIndex = 0; // ëª¨ë“œ ë³€ê²½ ì‹œ ì²« ì¹´ë“œë¡œ (setModeì—ì„œ ì²˜ë¦¬)
                    setMode(btn.dataset.mode);
                });
            });


            btnBackToQuiz.addEventListener('click', () => {
                 setMode(lastQuizMode); // ì´ì „ í€´ì¦ˆ ëª¨ë“œë¡œ ì„¤ì •
                 currentIndex = quizReturnIndex; // ì´ì „ í€´ì¦ˆ ì¸ë±ìŠ¤ë¡œ ë³µê·€
                 renderQuiz(); // í•´ë‹¹ í€´ì¦ˆ ë‹¤ì‹œ ë Œë”ë§
             });


            // --- ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ---
            initializeApp();
        });
    </script>
</body>
</html>